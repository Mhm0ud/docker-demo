
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
	<title>Moleculer Docker Demo</title>
	<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
	<link rel="shortcut icon" type="image/png" href="https://moleculer.services/icon/favicon-16x16.png"/>
	<script src="https://unpkg.com/vue@2.6.11/dist/vue.js"></script>
	<style type="text/css">
	html {
		font-family: "Source Sans Pro", Helvetica, Arial, sans-serif;
		font-size: 18px;
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
	}

	body {
		padding: 0;
		margin: 0;
		color: black;
		text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
		padding-bottom: 60px; /* footer */
	}

	header, footer {
		text-align: center;
		color: white;
		text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
	}

	header a, header a.router-link-exact-active,
	footer a, footer a.router-link-exact-active
	{
		color: #63dcfd;
	}

	header {
		background-image: linear-gradient(45deg, #e37682 0%, #5f4d93 100%);
		padding: 1em;
		box-shadow: 0 3px 10px rgba(0,0,0,0.6);
		margin-bottom: 1em;
	}

	footer {
		background-image: linear-gradient(135deg, #e37682 0%, #5f4d93 100%);
		padding: 0.75em;		
		font-size: 0.8em;
		box-shadow: 0 -3px 10px rgba(0,0,0,0.6);
		position: fixed;
		left: 0; right: 0; bottom: 0;
		margin-top: 1em;
	}

	footer .footer-links {
		margin-top: 0.5em;
	}

	footer .footer-links a {
		margin: 0 0.5em;
	}

	header h1 {
		font-weight: 300;
		color: #63dcfd;
	}

	a, a.router-link-exact-active {
		color: #3CAFCE;
		text-decoration: none;
	}

	img.logo {
		height: 100px;
		/*-webkit-filter: drop-shadow(0px 0px 3px #222);*/
		filter: drop-shadow(1px 1px 3px rgba(0,0,0, 0.3));		
	}

	nav ul {
		list-style: none;
		padding: 0;
	}

	nav ul li {
		display: inline-block;
		padding: 0.25em 0.75em;
		cursor: pointer;
		font-weight: 300;
		font-size: 1.25em;
		border-bottom: 2px solid transparent;
		transition: color .1s linear, border-bottom .1s linear;
	}

	nav ul li.active {
		border-bottom: 2px solid #63dcfd;
	}

	nav ul li:hover {
		color: #63dcfd;
	}

	button, .button {
		background-color: #3CAFCE;
		border: 0;
		border-radius: 8px;
		color: white;
		font-family: "Source Sans Pro", Helvetica, Arial, sans-serif;
		font-size: 16px;
		font-weight: 400;
		padding: 0.5em 1em;
		box-shadow: 0 4px 6px -1px rgba(0,0,0,.2);
		cursor: pointer;
	}

	button:hover, .button:hover {
		background-color: #4ba3bb;
	}

	code {
		font-family: "Consolas", 'Courier New', Courier, monospace;
		color: #555;
	}

	main {
		max-width: 960px;
		margin: 0 auto;
		padding: 1em 1em;
	}

	main fieldset {
		border: 1px solid lightgrey;
		border-radius: 8px;
		box-shadow: 2px 2px 10px rgba(0,0,0,0.4);
		background-color: aliceblue;
		margin-bottom: 2em;
	}

	main fieldset legend {
		background-color: #cce7ff;
		border: 1px solid lightgrey;
		padding: 4px 10px;
		border-radius: 8px;		
	}

	main fieldset .content {
		padding-left: 2em;
	}

	main fieldset .request {
		margin-bottom: 0.5em;
	}

	main fieldset .response {
		margin-top: 1em;
	}

	main fieldset .response pre {
		margin: 0.5em 0;
	}

	main h4 {
		font-weight: 600;
		margin: 0.25em -1.0em;
	}

	.badge {
		display: inline-block;
		background-color: dimgray;
		color: white;
    	padding: 4px 6px;
	    border-radius: 7px;
	    font-size: 0.7em;
		font-weight: 600;
	}

	.badge.green {
		background-color: limegreen;
	}

	.badge.red {
		background-color: firebrick;
	}

	table {
		width: 100%;
		max-width: 1000px;
		border: 1px solid lightgrey;
		border-radius: 8px;
		background-color: aliceblue;
    }
    
    table th {
		padding: 2px 4px;
		background-color: #cce7ff;
		border-radius: 4px;
    }
    
    table tr.offline td {
		font-style: italic;
		color: #777;
    }

    table tr.local td {
    	/*color: blue;*/
    }
    
    table tr:not(:last-child) td {
		border-bottom: 1px solid #ddd;
    }

    table td {
		text-align: center;
		position: relative;
		padding: 2px 4px;
    }
      
    table th:nth-child(1), table td:nth-child(1) {
		text-align: left
    }	

	.bar {
		position: absolute;
		left: 0; right: 0; top: 0; bottom: 0;
		width: 0;
		height: 100%;
		background-color: rgba(0,0,0,0.3);
	}	
</style>
</head>
<body>
	<div id="app">
		<header>
			<a href="https://moleculer.services/docs/0.14/" target="_blank"><img class="logo" src="https://moleculer.services/images/logo/logo_with_text_horizontal.png" /></a>
			<h1>Welcome to your Moleculer microservices project!</h1>
			<!-- p>For a guide and recipes on how to configure / customize this project,<br/>check out the <a href="https://moleculer.services/docs/0.14/" target="_blank">Moleculer documentation</a>.</p-->
			<nav>
				<ul>
					<li v-for="item in menu" :class="{ active: page == item.id}" @click="changePage(item.id)">{{ item.caption }}</li>
				</ul>
			</nav>
		</header>

		<main>
			<section id="home" v-if="page == 'home'">
				<fieldset v-for="item in requests">
					<legend>
						Action '<code>{{ item.action }}</code>'
					</legend>
					<div class="content">
						<div class="request">
							<h4>Request:</h4>
							<code>{{ item.method || 'GET' }} {{ item.rest }}   </code>
							<a class="button" @click="callAction(item)">Execute</a>
						</div>
						<div class="response" v-if="item.status">
							<h4>Response: 
								<div class="badge" :class="{ green: item.status < 400, red: item.status >= 400 || item.status == 'ERR' }">{{ item.status }}</div>
								<div class="badge time">{{ humanize(item.duration) }}</div>
							</h4>
							<pre><code>{{ item.response }}</code></pre>
						</div>
					</div>
				</fieldset>
			</section>

			<section id="nodes" v-else-if="page == 'nodes'">
				<table>
					<thead> 
						<th>Node ID</th>
						<th>Type</th>
						<th>Version</th>
						<th>IP</th>
						<th>Status</th>
						<th>CPU</th>
					</thead>
					<tbody>
						<tr v-for="node in nodes" :class="{ offline: !node.available, local: node.local }" :key="node.id">
							<td>{{ node.id }}</td>
							<td>{{ node.client.type }}</td>
							<td>{{ node.client.version }}</td>
							<td>{{ node.ipList.length > 0 ? node.ipList[0] : node.hostnae }}</td>
							
							<td><div class="badge" :class="{ green: node.available, red: !node.available }">{{ node.available ? "Online": "Offline" }}</div></td>
							<td>
								<div class="bar" :style="{ width: node.cpu + '%' }"></div>
								{{ node.cpu != null ? Number(node.cpu).toFixed(0) + '%' : '-' }}
							</td>
						</tr>
					</tbody>        
				</table>
			</section>
			<section id="services" v-else-if="page == 'services'">
				<table>
					<thead>
						<th>Service name</th>
						<th>Version</th>
						<th>Instances</th>
					</thead>
					<tbody>
						<tr v-for="svc in services">
							<td>{{ svc.name }}</td>
							<td>{{ svc.version ? svc.version : "-" }}</td>
							<td class="badges">
								<div class="badge" v-for="nodeID in svc.nodes">
									{{ nodeID }}
								</div>
							</td>
						</tr>
					</tbody>
				</table>				
			</section>
			<section id="actions" v-else-if="page == 'actions'">
				<table>
					<thead>
						<th>Action name</th>
						<th>Cached</th>
						<th>Instances</th>
						<th>Status</th>
					</thead>
					<tbody>
						<tr v-for="action in actions" :class="{ offline: !action.available, local: action.hasLocal }">
							<td>{{ action.name }}</td>
							<td>
								<template v-if="action.action">
									<div class="badge" v-if="action.action.cache">
										Yes
									</div>
									<span v-else>No</span>
								</template>
							</td>
							<td>{{ action.count }}</td>
							<td><div class="badge" :class="{ green: action.available, red: !action.available }">{{ action.available ? "Online": "Offline" }}</div></td>
						</tr>
					</tbody>
				</table>
			</section>
		</main>

		<footer>
			<div class="footer-copyright">
				Copyright &copy; 2016-2019 - Moleculer
			</div>
			<div class="footer-links">
				<a href="https://github.com/moleculerjs/moleculer" class="footer-link" target="_blank">Github</a>
				<a href="https://twitter.com/MoleculerJS" class="footer-link" target="_blank">Twitter</a>
				<a href="https://discord.gg/TSEcDRP" class="footer-link" target="_blank">Discord</a>
				<a href="https://stackoverflow.com/questions/tagged/moleculer" class="footer-link" target="_blank">Stack Overflow</a>
			</div>
		</footer>
	</div>

	<script type="text/javascript">
		var app = new Vue({
			el: "#app",

			data: {
				menu: [
					{ id: "home", caption: "Home" },
					{ id: "nodes", caption: "Nodes" },
					{ id: "services", caption: "Services" },
					{ id: "actions", caption: "Actions" },
				],
				page: "home",

				requests: [
					{ id: "hello", action: "greeter.hello", rest: "/api/greeter/hello", response: null, status: null, duration: null },
					{ id: "welcome", action: "greeter.welcome", rest: "/api/greeter/welcome?name=John", response: null, status: null, duration: null }
				],

				responses: {
					hello: null,
					welcome: null
				},
				nodes: [],
				services: [],
				actions: [],
			},

			methods: {
				changePage(page) {
					this.page = page;
					this.updatePageResources();
				},

				humanize(ms) {
					if (ms > 1500) {
						return (ms / 1500).toFixed(2) + " s";
					}
					return ms + " ms";
				},

				callAction: function (item) {
					var startTime = Date.now();

					return fetch(item.rest, { method: item.method || "GET"/*, body: params ? JSON.stringify(params) : null*/ })
						.then(function(res) {
							item.status = res.status;
							item.duration = Date.now() - startTime;
							return res.json().then(function(json) {
								item.response = json;
							});
						})
						.catch(function (err) {
							item.status = "ERR";
							item.duration = Date.now() - startTime;
							item.response = err.message;
							console.log(err);
						});

				},

				updateNodeList: function (name) {
					this.req("/api/~node/list", null, false).then(res => this.nodes = res);
				},

				updateServiceList: function (name) {
					this.req("/api/~node/services", null, false).then(res => this.services = res);
				},

				updateActionList: function (name) {
					this.req("/api/~node/actions", null, false).then(res => this.actions = res);
				},

				req: function (url, params, print = true) {
					var self = this;
					return fetch(url, { method: "GET", body: params ? JSON.stringify(params) : null })
						.then(function(res) {
							return res.json();
						})
						.then(function (res) {
							if (print)
								self.response = res;
							return res;
						})
						.catch(function (err) {
							if (print)
								self.response = err.message;
							throw err;
						});
				},

				updatePageResources() {
					if (this.page == 'nodes') return this.updateNodeList();
					if (this.page == 'services') return this.updateServiceList();
					if (this.page == 'actions') return this.updateActionList();
				}
			},

			mounted() {
				var self = this;
				setInterval(function () {
					self.updatePageResources();
				}, 2000);
			}
		});	
	</script>
</body>
</html>
